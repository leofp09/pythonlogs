from flask import Flask, request, jsonify

import logging
from google.cloud import logging as gcl

log_name = "SNITCH"
gcloud_logging_client = gcl.Client()
gcloud_logging_handler = gcl.handlers.CloudLoggingHandler(gcloud_logging_client, name=log_name)
stream_handler = logging.StreamHandler()
logger = logging.getLogger(log_name)
logger.addHandler(stream_handler)
logger.addHandler(gcloud_logging_handler)

app = Flask(__name__)

@app.route('/')
def homepage():
  return 'api no ar'
  
@app.route('/sendlog', methods=['POST','GET'])
def send_log():
    content = request.get_json()
    
    if content['level'] == 'debug' : loglevel = 100
    elif content['level'] == 'info' : loglevel = 200
    elif content['level'] == 'notice' : loglevel = 300
    elif content['level'] == 'warning' : loglevel = 400
    elif content['level'] == 'error' : loglevel = 500
    elif content['level'] == 'critical' : loglevel = 600
    elif content['level'] == 'alert' : loglevel = 700
    elif content['level'] == 'emergency' : loglevel = 800
    else: loglevel = 0

    

    logger.log(msg=content['text'],level=loglevel)
    print('a')

  
    return jsonify(content)

@app.route('/listentries', methods=['POST','GET'])
def list_entries():
    content = request.get_json()
    logger_name = content['logname']

    logging_client = gcl.Client()
    logger = logging_client.logger(logger_name)

    lista = []
    for entry in logger.list_entries(filter_="severity>=EMERGENCY"):
        timestamp = entry.timestamp.isoformat()
        lista.append(timestamp + "  " + entry.payload + "  " + entry.severity)
        
    
    entries = {
            logger.name: lista
        }
   
    return jsonify(entries)

@app.route('/delete', methods=['POST','GET'])
def delete_logger():
    content = request.get_json()
    logger_name = content['logname']
   
    logging_client = gcl.Client()
    logger = logging_client.logger(logger_name)

    logger.delete()

    deleted = {
        "deleted": logger.name
    }
    
   



app.run(host= '0.0.0.0')